import { Component, useState, useEffect } from "react"; import "@/App.css"; import { BrowserRouter, Routes, Route, Navigate, useLocation, useNavigate } from "react-router-dom"; import { Menu } from "lucide-react"; import { Sidebar } from "./components/Sidebar"; import { Dashboard } from "./components/Dashboard"; import { MealsPage } from "./components/MealsPage"; import { SportPage } from "./components/SportPage"; import { PerformancePage } from "./components/PerformancePage"; import { ProfilePage } from "./components/ProfilePage"; import { ChronoPage } from "./components/ChronoPage"; import { TrophiesPage } from "./components/TrophiesPage"; import { ProgramsPage } from "./components/ProgramsPage"; import { SettingsPage } from "./components/SettingsPage"; import { RemindersPage } from "./components/RemindersPage"; import { ChallengesPage } from "./components/ChallengesPage"; import { SleepPage } from "./components/SleepPage"; import { ProgressionPage } from "./components/ProgressionPage"; import { SmartPlanningPage } from "./components/SmartPlanningPage"; import { OnboardingFlow } from "./components/OnboardingFlow"; import { LoginPage } from "./components/LoginPage"; import { AuthCallback } from "./components/AuthCallback"; import { AuthProvider } from "./context/AuthContext"; import { useAuth } from "./context/AuthContext"; import { XPProvider } from "./context/XPContext"; import { ThemeProvider } from "./context/ThemeContext"; import { Toaster } from "./components/ui/sonner"; // SIMPLE ERROR BOUNDARY FOR MOBILE DEBUGGING class ErrorBoundary extends Component { constructor(props) { super(props); this.state = { hasError: false, error: null, errorInfo: null }; } static getDerivedStateFromError(error) { return { hasError: true }; } componentDidCatch(error, errorInfo) { this.setState({ error, errorInfo }); console.error("Uncaught error:", error, errorInfo); } render() { if (this.state.hasError) { return ( <div style={{ padding: 20, color: 'red', background: 'black', height: '100vh', overflow: 'auto' }}> <h1>Something went wrong.</h1> <details style={{ whiteSpace: 'pre-wrap' }}> {this.state.error && this.state.error.toString()} <br /> {this.state.errorInfo && this.state.errorInfo.componentStack} </details> </div> ); } return this.props.children; } } // Protected Route Component with Onboarding Check const ProtectedRoute = ({ children }) => { const { isAuthenticated, loading, user, refreshUser } = useAuth(); const [showOnboarding, setShowOnboarding] = useState(false); const [checkComplete, setCheckComplete] = useState(false); const navigate = useNavigate(); useEffect(() => { if (!loading && !isAuthenticated) { navigate('/login', { replace: true }); } }, [loading, isAuthenticated, navigate]); useEffect(() => { if (user && !checkComplete) { setCheckComplete(true); const isOnboardingCompleted = user.onboarding_completed === true; const localOnboardingComplete = localStorage.getItem(`fitquest_onboarding_${user.user_id}`); if (!isOnboardingCompleted && localOnboardingComplete !== 'true') { setShowOnboarding(true); } else { setShowOnboarding(false); } } }, [user, checkComplete]); const handleOnboardingComplete = async () => { if (user?.user_id) { localStorage.setItem(`fitquest_onboarding_${user.user_id}`, 'true'); } setShowOnboarding(false); await refreshUser(); }; if (loading) { return ( <div className="min-h-screen bg-[#050505] flex items-center justify-center"> <div className="spinner"></div> </div> ); } if (!isAuthenticated) { return ( <div style={{ color: 'red', padding: 20 }}> DEBUG: Not Authenticated. Redirecting... </div> ) } if (showOnboarding) { return ( <OnboardingFlow onComplete={handleOnboardingComplete} /> ); } return ( <> {children} </> ); }; const MainLayout = ({ children }) => { const [sidebarOpen, setSidebarOpen] = useState(false); return ( <div className="app-container grid-bg"> {!sidebarOpen && ( <button className="mobile-menu-btn" onClick={() => setSidebarOpen(true)} data-testid="mobile-menu-btn" > <Menu className="w-5 h-5" /> </button> )} <Sidebar isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} /> <main className="main-content"> {children} </main> </div> ); }; const AppRouter = () => { const location = useLocation(); const { isAuthenticated, loading } = useAuth(); if (location.hash?.includes('session_id=')) { return <AuthCallback />; } if (location.search?.includes('code=')) { if (isAuthenticated) { return <Navigate to="/dashboard" replace />; } return ( <div className="min-h-screen bg-[#050505] flex flex-col items-center justify-center"> <div className="spinner mb-4"></div> <p className="text-[#B0E301] font-mono text-sm animate-pulse">Connexion Ã  Google en cours...</p> </div> ); } return ( <> <Routes> <Route path="/login" element={<LoginPage />} /> <Route path="/dashboard" element={ <ProtectedRoute> <MainLayout> <Dashboard /> </MainLayout> </ProtectedRoute> } /> <Route path="/repas" element={ <ProtectedRoute> <MainLayout> <MealsPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/sport" element={ <ProtectedRoute> <MainLayout> <SportPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/performances" element={ <ProtectedRoute> <MainLayout> <PerformancePage /> </MainLayout> </ProtectedRoute> } /> <Route path="/profil" element={ <ProtectedRoute> <MainLayout> <ProfilePage /> </MainLayout> </ProtectedRoute> } /> <Route path="/chrono" element={ <ProtectedRoute> <MainLayout> <ChronoPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/trophees" element={ <ProtectedRoute> <MainLayout> <TrophiesPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/programmes" element={ <ProtectedRoute> <MainLayout> <ProgramsPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/defis" element={ <ProtectedRoute> <MainLayout> <ChallengesPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/rappels" element={ <ProtectedRoute> <MainLayout> <RemindersPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/parametres" element={ <ProtectedRoute> <MainLayout> <SettingsPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/sommeil" element={ <ProtectedRoute> <MainLayout> <SleepPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/progression" element={ <ProtectedRoute> <MainLayout> <ProgressionPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/planning" element={ <ProtectedRoute> <MainLayout> <SmartPlanningPage /> </MainLayout> </ProtectedRoute> } /> <Route path="/" element={<Navigate to="/dashboard" replace />} /> <Route path="*" element={<Navigate to="/dashboard" replace />} /> </Routes > </> ); }; function App() { return ( <div style={{ minHeight: '100vh', boxSizing: 'border-box' }}> <ErrorBoundary> <AuthProvider> <XPProvider> <ThemeProvider> <BrowserRouter> <AppRouter /> <Toaster position="bottom-right" toastOptions={{ style: { background: '#0A0A0A', border: '1px solid rgba(255,255,255,0.1)', color: '#FFFFFF' } }} /> </BrowserRouter> </ThemeProvider> </XPProvider> </AuthProvider> </ErrorBoundary> </div> ); } export default App;