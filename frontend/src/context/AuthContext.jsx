import { createContext, useContext, useState, useEffect, useCallback, useRef, useMemo } from 'react'; import axios from 'axios'; const BACKEND_URL = process.env.REACT_APP_BACKEND_URL; const API = `${BACKEND_URL}/api`; const AuthContext = createContext(null); export const useAuth = () => { const context = useContext(AuthContext); if (!context) { throw new Error('useAuth must be used within AuthProvider'); } return context; }; axios.defaults.withCredentials = true; axios.interceptors.request.use( config => { const token = localStorage.getItem('session_token'); if (token) { config.headers['Authorization'] = `Bearer ${token}`; } return config; }, error => Promise.reject(error) ); export const AuthProvider = ({ children }) => { const [user, setUser] = useState(null); const [loading, setLoading] = useState(true); const [error, setError] = useState(null); const [lastSync, setLastSync] = useState(Date.now()); const processedCode = useRef(null); const checkAuth = useCallback(async () => { try { const response = await axios.get(`${API}/auth/me`, { withCredentials: true }); setUser(response.data); setError(null); } catch (err) { setUser(null); if (err.response?.status !== 401) { setError('Authentication check failed'); } } finally { setLoading(false); } }, []); useEffect(() => { const initAuth = async () => { const params = new URLSearchParams(window.location.search); const code = params.get('code'); if (code && !user) { if (processedCode.current === code) return; processedCode.current = code; try { const redirectUri = sessionStorage.getItem('google_redirect_uri') || "http://100.97.192.62.nip.io:3000"; const res = await axios.post(`${API}/auth/google/callback`, { code, redirect_uri: redirectUri }); if (res.data.session_token) { localStorage.setItem('session_token', res.data.session_token); await new Promise(resolve => setTimeout(resolve, 2000)); window.history.replaceState({}, document.title, window.location.pathname); await checkAuth(); } } catch (err) { console.error("Auth callback failed", err); setError("Authentication failed."); window.history.replaceState({}, document.title, window.location.pathname); } return; } if (!user) { await checkAuth(); } }; initAuth(); }, [checkAuth]); const login = () => { const clientId = "158036171715-agr13rgmehc083e75vm0qdb409a89u9q.apps.googleusercontent.com"; let redirectUri = "http://100.97.192.62.nip.io:3000"; if (window.location.hostname === "localhost") { redirectUri = "http://localhost:3000"; } const scope = "openid email profile"; const responseType = "code"; sessionStorage.setItem('google_redirect_uri', redirectUri); const googleUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=${responseType}&scope=${encodeURIComponent(scope)}`; window.location.href = googleUrl; }; const logout = async () => { try { await axios.post(`${API}/auth/logout`, {}, { withCredentials: true }); } catch (err) { console.error('Logout error:', err); } finally { localStorage.removeItem('session_token'); setUser(null); } }; const updateUser = async (updates) => { try { const response = await axios.put(`${API}/users/me`, updates, { withCredentials: true }); setUser(response.data); return response.data; } catch (err) { throw err; } }; const processSession = async (sessionId) => { try { setLoading(true); const response = await axios.get(`${API}/auth/session?session_id=${sessionId}`, { withCredentials: true }); setUser(response.data); setError(null); setLoading(false); return response.data; } catch (err) { setError('Failed to process session'); setLoading(false); throw err; } }; const refreshUser = useCallback(async () => { try { const response = await axios.get(`${API}/auth/me`, { withCredentials: true }); setUser(response.data); } catch (err) { console.error('Refresh user error:', err); } }, []); const devLogin = async () => { try { const response = await axios.get(`${API}/auth/login/dev`, { withCredentials: true }); setUser(response.data.user); window.location.reload(); } catch (err) { console.error("Dev login failed", err); } }; useEffect(() => { const handleVisibilityChange = () => { if (document.visibilityState === 'visible' && user) { axios.get(`${API}/auth/me`, { withCredentials: true }) .then(res => { setUser(res.data); setLastSync(Date.now()); }) .catch(() => { }); } }; window.addEventListener('visibilitychange', handleVisibilityChange); window.addEventListener('focus', handleVisibilityChange); return () => { window.removeEventListener('visibilitychange', handleVisibilityChange); window.removeEventListener('focus', handleVisibilityChange); }; }, [user]); const authValue = useMemo(() => ({ user, loading, error, lastSync, login, logout, updateUser, processSession, checkAuth, refreshUser, devLogin, isAuthenticated: !!user, debugLogs: [], addLog: () => {} }), [user, loading, error, checkAuth, refreshUser]); return ( <AuthContext.Provider value={authValue}> {children} </AuthContext.Provider> ); };
